# E0-T0.2: Schema Utilities and Base Types

**Epic:** 0 - Project Setup & Infrastructure
**Parent:** E0-T0 (Database Setup)
**Story Points:** 1
**Priority:** P0 (Blocker)
**Assignee:** Backend Developer
**Estimated Time:** 20 minutes
**Dependencies:** E0-T0.1

---

## Objective

Create reusable schema utilities for timestamps, soft deletes, and metadata columns to ensure consistency across all database tables.

---

## Implementation

### File: `drizzle/schema/utils.ts`

```typescript
import { sql } from 'drizzle-orm'
import { timestamp, jsonb } from 'drizzle-orm/pg-core'
import type { AnyPgColumn } from 'drizzle-orm/pg-core'

/**
 * Standard timestamp columns for audit trail
 * Used across all tables to track creation and updates
 */
export const timestamps = {
  createdAt: timestamp('created_at', { withTimezone: true })
    .defaultNow()
    .notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true })
    .defaultNow()
    .notNull(),
}

/**
 * Soft delete column
 * Allows marking records as deleted without physical deletion
 * Enables audit trail and data recovery
 */
export const softDelete = {
  deletedAt: timestamp('deleted_at', { withTimezone: true }),
}

/**
 * Metadata column for extensibility
 * JSONB allows flexible data storage without schema migrations
 * Queryable with PostgreSQL JSON operators
 */
export const metadata = {
  metadata: jsonb('metadata')
    .default(sql`'{}'::jsonb`)
    .notNull(),
}

/**
 * Helper function to check if a value matches a regex pattern
 * Used for CHECK constraints (email format, wallet format, etc.)
 *
 * @param column - The column to check
 * @param pattern - Regex pattern (PostgreSQL ~* syntax)
 * @returns SQL expression for CHECK constraint
 */
export function checkPattern(column: AnyPgColumn, pattern: string) {
  return sql`${column} ~* ${pattern}`
}

/**
 * Common regex patterns for validation
 */
export const PATTERNS = {
  // Email: standard format (RFC 5322 simplified)
  EMAIL: '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$',

  // Ethereum address: 0x followed by 40 hex characters
  ETH_ADDRESS: '^0x[a-fA-F0-9]{40}$',

  // Username: lowercase alphanumeric + underscores, 3-50 chars
  USERNAME: '^[a-z0-9_]{3,50}$',

  // Country code: ISO 3166-1 alpha-2 (2 uppercase letters)
  COUNTRY_CODE: '^[A-Z]{2}$',

  // Invitation code: 8 uppercase alphanumeric characters
  INVITE_CODE: '^[A-Z0-9]{8}$',
} as const
```

---

## Design Rationale

### 1. Timestamps Helper

**Purpose:** Consistent audit trail across all tables

**Benefits:**
- Automatic timestamp management
- Standardized column names (`created_at`, `updated_at`)
- Timezone-aware (TIMESTAMPTZ)
- Default to NOW() for convenience

**Usage Example:**
```typescript
export const users = pgTable('users', {
  id: uuid('id').primaryKey(),
  // ... other columns
  ...timestamps,  // Adds createdAt and updatedAt
})
```

---

### 2. Soft Delete Helper

**Purpose:** Non-destructive deletion with audit trail

**Benefits:**
- Preserves data for compliance/audit
- Enables "undo" functionality
- Allows historical data analysis
- Simple restoration (set `deleted_at = NULL`)

**Query Example:**
```typescript
// Only get active records
WHERE deleted_at IS NULL

// Get deleted records
WHERE deleted_at IS NOT NULL
```

---

### 3. Metadata Helper

**Purpose:** Extensible data storage without schema changes

**Benefits:**
- Add new fields without migrations
- Queryable with PostgreSQL JSON operators
- Perfect for feature flags, preferences, NFT data
- JSONB is indexed and performant

**Use Cases:**
- User preferences: `{ theme: 'dark', language: 'es' }`
- NFT memberships: `{ nfts: [{ contract, tokenId, chain }] }`
- Feature flags: `{ earlyAccess: true, betaTester: true }`
- Privy data: `{ walletCreatedAt, linkedAccounts }`

---

### 4. Pattern Validation

**Purpose:** Reusable regex patterns for CHECK constraints

**Benefits:**
- Consistent validation across tables
- Centralized pattern definitions
- Type-safe with TypeScript
- Easy to update globally

---

## Testing

Create test file: `scripts/test-utils.ts`

```typescript
import { sql } from 'drizzle-orm'
import { PATTERNS, checkPattern } from '../drizzle/schema/utils'

// Test patterns
const testCases = [
  // Email
  { pattern: PATTERNS.EMAIL, valid: 'user@example.com', invalid: 'notanemail' },

  // Ethereum address
  { pattern: PATTERNS.ETH_ADDRESS, valid: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb5', invalid: '0x123' },

  // Username
  { pattern: PATTERNS.USERNAME, valid: 'carlos_dev', invalid: 'Carlos-Dev' },

  // Country code
  { pattern: PATTERNS.COUNTRY_CODE, valid: 'MX', invalid: 'Mexico' },

  // Invite code
  { pattern: PATTERNS.INVITE_CODE, valid: 'ABC123XY', invalid: 'abc123xy' },
]

testCases.forEach(({ pattern, valid, invalid }) => {
  console.log(`Testing pattern: ${pattern}`)
  console.log(`  Valid: ${valid} ✓`)
  console.log(`  Invalid: ${invalid} ✗`)
})

console.log('\\n✅ All patterns defined correctly')
```

Run test:
```bash
bun run scripts/test-utils.ts
```

---

## Acceptance Criteria

- [ ] `drizzle/schema/utils.ts` created with all helpers
- [ ] `timestamps` helper exports `createdAt` and `updatedAt`
- [ ] `softDelete` helper exports `deletedAt`
- [ ] `metadata` helper exports JSONB column with default empty object
- [ ] `checkPattern` helper function defined
- [ ] `PATTERNS` constant with all validation patterns
- [ ] All patterns tested and validated
- [ ] TypeScript types properly exported

---

## Files Created

- `drizzle/schema/utils.ts`
- `scripts/test-utils.ts` (optional test file)

---

## Next Ticket

**E0-T0.3:** Create Users Table Schema

---

## Notes

- These utilities are used by ALL table schemas
- JSONB default must be cast: `'{}'::jsonb`
- Patterns use PostgreSQL regex syntax (`~*` for case-insensitive)
- Soft deletes require app-level filtering (`WHERE deleted_at IS NULL`)

---

**Status:** ✅ Ready for Implementation
**Blocking:** E0-T0.3, E0-T0.4, E0-T0.5, E0-T0.6
**Estimated Completion:** 20 minutes
