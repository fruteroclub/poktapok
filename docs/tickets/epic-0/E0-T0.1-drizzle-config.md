# E0-T0.1: Drizzle Configuration & Project Structure

**Epic:** 0 - Project Setup & Infrastructure
**Parent:** E0-T0 (Database Setup)
**Story Points:** 1
**Priority:** P0 (Blocker)
**Assignee:** Backend Developer
**Estimated Time:** 30 minutes

---

## Objective

Set up Drizzle ORM configuration and create the initial project structure for database schema management.

---

## Prerequisites

- ✅ Dependencies installed (`drizzle-orm`, `postgres`, `drizzle-kit` already installed)
- ✅ Database URL added to `.env.local`
- ✅ Vercel CLI configured (for env sync)

---

## Implementation Steps

### Step 1: Create Drizzle Configuration

**File:** `drizzle.config.ts` (project root)

```typescript
import { defineConfig } from 'drizzle-kit'
import * as dotenv from 'dotenv'

// Load environment variables from .env.local
dotenv.config({ path: '.env.local' })

export default defineConfig({
  // Schema location
  schema: './drizzle/schema/index.ts',

  // Output directory for migrations
  out: './drizzle/migrations',

  // Database dialect
  dialect: 'postgresql',

  // Database credentials
  dbCredentials: {
    // Use non-pooling URL for migrations (direct connection)
    url: process.env.POSTGRES_URL_NON_POOLING || process.env.DATABASE_URL!,
  },

  // Verbose logging
  verbose: true,

  // Strict mode (fail on warnings)
  strict: true,

  // Migration configuration
  migrations: {
    table: 'drizzle_migrations',
    schema: 'public',
  },
})
```

**Key Points:**

- Uses `POSTGRES_URL_NON_POOLING` for direct connection (required for migrations)
- Strict mode catches potential schema issues early
- Migrations tracked in `drizzle_migrations` table

---

### Step 2: Create Directory Structure

```bash
# Create schema directory
mkdir -p drizzle/schema

# Create migrations directory (will be populated by drizzle-kit)
mkdir -p drizzle/migrations

# Create database client directory
mkdir -p src/lib/db

# Create scripts directory for verification
mkdir -p scripts
```

**Expected structure:**

```
project-root/
├── drizzle/
│   ├── schema/          # Schema definitions
│   │   ├── users.ts
│   │   ├── profiles.ts
│   │   ├── applications.ts
│   │   ├── invitations.ts
│   │   ├── utils.ts
│   │   └── index.ts
│   └── migrations/      # Generated SQL migrations
│       ├── 0000_initial.sql
│       └── meta/
├── src/lib/db/
│   ├── index.ts         # Database client
│   └── schema.ts        # Re-export schemas
├── scripts/
│   ├── verify-schema.ts
│   └── test-normalization.ts
└── drizzle.config.ts
```

---

### Step 3: Verify Environment Variables

```bash
# Check that database URL is set
cat .env.local | grep POSTGRES_URL

# Should output:
# POSTGRES_URL=postgresql://...
# POSTGRES_URL_NON_POOLING=postgresql://...
```

**If missing:**

```bash
# Pull from Vercel
vercel env pull .env.local

# Or add manually to .env.local
echo "POSTGRES_URL=your_connection_string" >> .env.local
echo "POSTGRES_URL_NON_POOLING=your_direct_connection_string" >> .env.local
```

---

### Step 4: Add Database Scripts to package.json

**File:** `package.json`

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",

    // Add these database scripts
    "db:generate": "drizzle-kit generate",
    "db:migrate": "drizzle-kit migrate",
    "db:studio": "drizzle-kit studio",
    "db:push": "drizzle-kit push",
    "db:check": "drizzle-kit check"
  }
}
```

**Script Descriptions:**

- `db:generate`: Generate migration files from schema changes
- `db:migrate`: Apply migrations to database
- `db:studio`: Open Drizzle Studio GUI (https://local.drizzle.studio)
- `db:push`: Push schema directly (development only, bypasses migrations)
- `db:check`: Validate migration files

---

### Step 5: Test Configuration

```bash
# Test Drizzle config loads correctly
bun run db:check

# Expected output:
# No schema changes detected
# (or warnings if schema files don't exist yet - this is fine)
```

---

## Acceptance Criteria

- [ ] `drizzle.config.ts` created with correct configuration
- [ ] `POSTGRES_URL_NON_POOLING` environment variable verified
- [ ] Directory structure created (`drizzle/schema/`, `drizzle/migrations/`, `src/lib/db/`)
- [ ] Database scripts added to `package.json`
- [ ] `bun run db:check` executes without errors
- [ ] Configuration uses verbose and strict mode

---

## Testing

```bash
# 1. Verify config file syntax
bun run db:check

# 2. Check environment variables
node -e "require('dotenv').config({ path: '.env.local' }); console.log('POSTGRES_URL:', process.env.POSTGRES_URL ? 'SET' : 'MISSING')"

# 3. Verify directory structure
ls -la drizzle/
ls -la src/lib/db/
```

---

## Files Created

- `drizzle.config.ts`
- `drizzle/schema/` (directory)
- `drizzle/migrations/` (directory)
- `src/lib/db/` (directory)
- `scripts/` (directory)

**Files Modified:**

- `package.json` (add 5 db scripts)

---

## Next Ticket

**E0-T0.2:** Create Schema Utilities and Base Types

---

## Notes

- This ticket is a prerequisite for all subsequent database tickets
- Configuration uses non-pooling connection for migrations (critical for Vercel Postgres)
- Strict mode helps catch schema design issues early
- Directory structure follows Drizzle best practices

---

**Status:** ✅ Ready for Implementation
**Blocking:** E0-T0.2, E0-T0.3, E0-T0.4, E0-T0.5
**Estimated Completion:** 30 minutes
