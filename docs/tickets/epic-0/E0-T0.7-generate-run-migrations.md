# E0-T0.7: Generate and Run Migrations

**Epic:** 0 - Project Setup & Infrastructure
**Parent:** E0-T0 (Database Setup)
**Story Points:** 2
**Priority:** P0 (Blocker)
**Assignee:** Backend Developer
**Estimated Time:** 30 minutes
**Dependencies:** E0-T0.6

---

## Objective

Generate Drizzle ORM migrations from the schema definitions and apply them to the Neon database. Verify that all tables, enums, constraints, and indexes are created correctly.

---

## Prerequisites

1. All schema files created (E0-T0.2 through E0-T0.5)
2. Database client configured (E0-T0.6)
3. `drizzle.config.ts` configured with DATABASE_URL_UNPOOLED (E0-T0.1)
4. Environment variables set:
   - `DATABASE_URL` (pooled connection)
   - `DATABASE_URL_UNPOOLED` (direct connection for migrations)

---

## Implementation Steps

### Step 1: Generate Migration Files

Run the Drizzle migration generator:

```bash
bun run db:generate
```

This will:

1. Read all schema files from `drizzle/schema/`
2. Compare with current database state
3. Generate SQL migration files in `drizzle/migrations/`

Expected output:

```
üì¶ Generating migrations...
‚úÖ Migration 0000_initial_schema.sql created
```

### Step 2: Review Generated Migration

Inspect the generated SQL file at `drizzle/migrations/0000_initial_schema.sql`:

Expected contents:

- CREATE TYPE statements for all enums
- CREATE TABLE statements for users, profiles, applications, invitations
- ALTER TABLE statements for foreign keys
- CREATE INDEX statements for all indexes
- CHECK constraints for validation

**Important:** Review the generated SQL carefully before applying!

### Step 3: Run Migration

Apply the migration to the database:

```bash
bun run db:migrate
```

This will:

1. Connect to database using DATABASE_URL_UNPOOLED
2. Execute all pending migrations
3. Update migration tracking table

Expected output:

```
üöÄ Running migrations...
‚úÖ Migration 0000_initial_schema.sql applied
üéâ All migrations completed successfully
```

### Step 4: Verify Migration

Run verification script to confirm all database objects were created:

```bash
bun run scripts/verify-migration.ts
```

---

## Verification Script

Create test file: `scripts/verify-migration.ts`

```typescript
import { db, closeDatabase } from '../src/lib/db'
import { sql } from 'drizzle-orm'

interface TableInfo {
  table_name: string
}

interface EnumInfo {
  enum_name: string
  enum_values: string[]
}

interface IndexInfo {
  indexname: string
  tablename: string
}

interface ConstraintInfo {
  constraint_name: string
  table_name: string
  constraint_type: string
}

async function verifyMigration() {
  console.log('üîç Verifying database migration...\n')

  try {
    // 1. Check all tables exist
    const tables = await db.execute<TableInfo>(sql`
      SELECT table_name
      FROM information_schema.tables
      WHERE table_schema = 'public'
        AND table_type = 'BASE TABLE'
      ORDER BY table_name
    `)

    const expectedTables = ['users', 'profiles', 'applications', 'invitations']
    const foundTables = tables.rows.map((r) => r.table_name)

    console.log('üìã Tables:')
    expectedTables.forEach((table) => {
      const found = foundTables.includes(table)
      console.log(`  ${found ? '‚úÖ' : '‚ùå'} ${table}`)
    })

    // 2. Check all enums exist
    const enums = await db.execute<{ typname: string }>(sql`
      SELECT typname
      FROM pg_type
      WHERE typcategory = 'E'
      ORDER BY typname
    `)

    const expectedEnums = [
      'user_role',
      'account_status',
      'auth_method',
      'profile_visibility',
      'availability_status',
      'learning_track',
      'application_status',
    ]
    const foundEnums = enums.rows.map((r) => r.typname)

    console.log('\nüìä Enums:')
    expectedEnums.forEach((enumName) => {
      const found = foundEnums.includes(enumName)
      console.log(`  ${found ? '‚úÖ' : '‚ùå'} ${enumName}`)
    })

    // 3. Check indexes
    const indexes = await db.execute<IndexInfo>(sql`
      SELECT indexname, tablename
      FROM pg_indexes
      WHERE schemaname = 'public'
        AND indexname NOT LIKE '%_pkey'
      ORDER BY tablename, indexname
    `)

    console.log('\nüîó Indexes:')
    const indexesByTable: Record<string, string[]> = {}
    indexes.rows.forEach((idx) => {
      if (!indexesByTable[idx.tablename]) {
        indexesByTable[idx.tablename] = []
      }
      indexesByTable[idx.tablename].push(idx.indexname)
    })

    Object.entries(indexesByTable).forEach(([table, idxList]) => {
      console.log(`  ${table}:`)
      idxList.forEach((idx) => console.log(`    ‚úÖ ${idx}`))
    })

    // 4. Check constraints
    const constraints = await db.execute<ConstraintInfo>(sql`
      SELECT constraint_name, table_name, constraint_type
      FROM information_schema.table_constraints
      WHERE table_schema = 'public'
        AND constraint_type IN ('CHECK', 'FOREIGN KEY', 'UNIQUE')
      ORDER BY table_name, constraint_type, constraint_name
    `)

    console.log('\nüîí Constraints:')
    const constraintsByTable: Record<string, { name: string; type: string }[]> = {}
    constraints.rows.forEach((con) => {
      if (!constraintsByTable[con.table_name]) {
        constraintsByTable[con.table_name] = []
      }
      constraintsByTable[con.table_name].push({
        name: con.constraint_name,
        type: con.constraint_type,
      })
    })

    Object.entries(constraintsByTable).forEach(([table, conList]) => {
      console.log(`  ${table}:`)
      conList.forEach((con) => console.log(`    ‚úÖ ${con.type}: ${con.name}`))
    })

    // 5. Check column counts
    const columns = await db.execute<{ table_name: string; column_count: number }>(sql`
      SELECT table_name, COUNT(*) as column_count
      FROM information_schema.columns
      WHERE table_schema = 'public'
      GROUP BY table_name
      ORDER BY table_name
    `)

    console.log('\nüìè Column Counts:')
    columns.rows.forEach((row) => {
      console.log(`  ${row.table_name}: ${row.column_count} columns`)
    })

    console.log('\nüéâ Migration verification completed successfully!')
  } catch (error) {
    console.error('‚ùå Migration verification failed:', error)
    throw error
  } finally {
    await closeDatabase()
  }
}

verifyMigration()
```

Run verification:

```bash
bun run scripts/verify-migration.ts
```

---

## Troubleshooting

### Issue: "Error connecting to database"

**Solution:** Check that DATABASE_URL_UNPOOLED is set correctly in `.env.local`

### Issue: "Migration already applied"

**Solution:** This is expected if you run migrations multiple times. Drizzle tracks which migrations have been applied.

### Issue: "SQL syntax error"

**Solution:**

1. Review the generated SQL in `drizzle/migrations/`
2. Check for syntax errors in schema files
3. Re-generate migrations with `bun run db:generate`

### Issue: "Foreign key constraint failed"

**Solution:** Ensure tables are created in the correct order. Drizzle should handle this automatically, but verify the migration SQL.

---

## Rollback Procedure

If migration fails and you need to rollback:

```bash
# Option 1: Drop all tables (destructive, use only in dev)
bun run db:studio
# Then manually drop tables in UI

# Option 2: Manual SQL rollback
psql $DATABASE_URL_UNPOOLED
DROP TABLE IF EXISTS invitations CASCADE;
DROP TABLE IF EXISTS applications CASCADE;
DROP TABLE IF EXISTS profiles CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP TYPE IF EXISTS user_role;
DROP TYPE IF EXISTS account_status;
-- etc.
```

---

## Acceptance Criteria

- [ ] Migration files generated in `drizzle/migrations/` directory
- [ ] Initial migration SQL reviewed and approved
- [ ] Migration applied successfully without errors
- [ ] All 4 tables created (users, profiles, applications, invitations)
- [ ] All 7 enums created
- [ ] All foreign keys created with correct CASCADE/SET NULL behavior
- [ ] All indexes created (24+ indexes total across all tables)
- [ ] All CHECK constraints created
- [ ] Verification script passes all checks
- [ ] Drizzle migration tracking table created

---

## Files Created

- `drizzle/migrations/0000_initial_schema.sql` (generated)
- `drizzle/migrations/meta/` (Drizzle internal tracking)
- `scripts/verify-migration.ts`

---

## Next Ticket

**E0-T0.8:** Verification and Team Sync

---

## Notes

- Always use DATABASE_URL_UNPOOLED for migrations (direct connection)
- Use DATABASE_URL for application queries (pooled connection)
- Migration files are version-controlled (commit them to git)
- Drizzle tracks applied migrations in internal table
- Never manually edit applied migrations (create new migration instead)
- Review generated SQL before applying in production

---

## Database State After This Ticket

After successful completion:

- ‚úÖ 4 tables created (users, profiles, applications, invitations)
- ‚úÖ 7 enums defined
- ‚úÖ 24+ indexes created
- ‚úÖ All foreign keys with proper CASCADE policies
- ‚úÖ All CHECK constraints applied
- ‚úÖ Database ready for application development

---

**Status:** ‚úÖ Ready for Implementation
**Blocking:** E0-T0.8
**Estimated Completion:** 30 minutes
