# E0-T0.6: Database Client and Schema Index

**Epic:** 0 - Project Setup & Infrastructure
**Parent:** E0-T0 (Database Setup)
**Story Points:** 1
**Priority:** P0 (Blocker)
**Assignee:** Backend Developer
**Estimated Time:** 20 minutes
**Dependencies:** E0-T0.1, E0-T0.2, E0-T0.3, E0-T0.4, E0-T0.5

---

## Objective

Create the centralized database client with connection pooling and a schema index file that exports all tables and types for easy importing throughout the application.

---

## Implementation

### File: `src/lib/db/index.ts`

```typescript
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'

/**
 * Database connection configuration
 *
 * Uses DATABASE_URL_UNPOOLED for migrations (direct connection)
 * Uses DATABASE_URL for application queries (connection pooling)
 *
 * Environment variables from Neon DB integration in Vercel
 */

// Get connection string from environment
const connectionString = process.env.DATABASE_URL!

if (!connectionString) {
  throw new Error('DATABASE_URL environment variable is not set')
}

// Create postgres client with connection pooling
export const client = postgres(connectionString, {
  max: 10, // Maximum connections in pool
  idle_timeout: 20, // Close idle connections after 20 seconds
  connect_timeout: 10, // Connection timeout in seconds
})

// Create Drizzle ORM instance
export const db = drizzle(client)

/**
 * Graceful shutdown helper
 * Call this when your application is shutting down
 */
export async function closeDatabase() {
  await client.end({ timeout: 5 })
  console.log('Database connection closed')
}
```

---

### File: `src/lib/db/schema.ts`

```typescript
/**
 * Central schema export file
 *
 * Import all tables and types from this file throughout the application
 *
 * Example usage:
 *   import { db } from '@/lib/db'
 *   import { users, type User } from '@/lib/db/schema'
 *
 *   const allUsers = await db.select().from(users)
 */

// ============================================================
// UTILITIES
// ============================================================

export * from '../../../drizzle/schema/utils'

// ============================================================
// TABLES
// ============================================================

export * from '../../../drizzle/schema/users'
export * from '../../../drizzle/schema/profiles'
export * from '../../../drizzle/schema/applications'
export * from '../../../drizzle/schema/invitations'

// ============================================================
// RE-EXPORT TYPES FOR CONVENIENCE
// ============================================================

import type { User, NewUser } from '../../../drizzle/schema/users'
import type { Profile, NewProfile } from '../../../drizzle/schema/profiles'
import type { Application, NewApplication } from '../../../drizzle/schema/applications'
import type { Invitation, NewInvitation } from '../../../drizzle/schema/invitations'

export type {
  User,
  NewUser,
  Profile,
  NewProfile,
  Application,
  NewApplication,
  Invitation,
  NewInvitation,
}
```

---

### File: `drizzle/schema/index.ts`

```typescript
/**
 * Schema index for Drizzle migrations
 *
 * This file is used by drizzle-kit to discover all tables when generating migrations
 */

export * from './utils'
export * from './users'
export * from './profiles'
export * from './applications'
export * from './invitations'
```

---

## Key Design Decisions

### 1. Neon DB Environment Variables

- `DATABASE_URL`: Used for application queries (pooled connection from Neon)
- `DATABASE_URL_UNPOOLED`: Used for migrations (direct connection)
- Both provided automatically by Vercel's Neon DB integration

### 2. Connection Pooling

- Uses `postgres` client with connection pooling (max 10 connections)
- Idle connections closed after 20 seconds to save resources
- Connection timeout set to 10 seconds

### 3. Centralized Schema Exports

- `src/lib/db/schema.ts`: Application imports (clean paths via path alias)
- `drizzle/schema/index.ts`: Migration discovery (drizzle-kit reads this)
- Separates concerns while avoiding duplication

### 4. Graceful Shutdown

- `closeDatabase()` function for clean shutdown
- 5-second timeout to close connections
- Should be called in server shutdown hooks

---

## Testing

Create test file: `scripts/test-db-connection.ts`

```typescript
import { db, closeDatabase } from '../src/lib/db'
import { users } from '../src/lib/db/schema'
import { sql } from 'drizzle-orm'

async function testDatabaseConnection() {
  console.log('ðŸ§ª Testing database connection...\n')

  try {
    // Test 1: Simple query
    const result = await db.execute(sql`SELECT NOW() as current_time`)
    console.log('âœ… Database connected:', result.rows[0])

    // Test 2: Count users
    const userCount = await db.select({ count: sql`COUNT(*)` }).from(users)
    console.log('âœ… User count:', userCount[0].count)

    // Test 3: Test all tables exist
    const tables = await db.execute(sql`
      SELECT table_name
      FROM information_schema.tables
      WHERE table_schema = 'public'
        AND table_type = 'BASE TABLE'
      ORDER BY table_name
    `)

    console.log('\nâœ… Tables found:')
    tables.rows.forEach((row: any) => console.log('  -', row.table_name))

    console.log('\nðŸŽ‰ Database connection tests passed!')
  } catch (error) {
    console.error('âŒ Database connection failed:', error)
    throw error
  } finally {
    await closeDatabase()
  }
}

testDatabaseConnection()
```

Run test:

```bash
bun run scripts/test-db-connection.ts
```

---

## Acceptance Criteria

- [ ] `src/lib/db/index.ts` created with connection pooling
- [ ] Uses DATABASE_URL environment variable (Neon DB)
- [ ] `src/lib/db/schema.ts` created with all exports
- [ ] `drizzle/schema/index.ts` created for migration discovery
- [ ] Connection pool configured (max 10, idle timeout 20s)
- [ ] Graceful shutdown function implemented
- [ ] Environment variable validation (throws if missing)
- [ ] Test script passes (connection works, tables exist)
- [ ] All schema types exported for application use

---

## Files Created

- `src/lib/db/index.ts`
- `src/lib/db/schema.ts`
- `drizzle/schema/index.ts`
- `scripts/test-db-connection.ts`

---

## Next Ticket

**E0-T0.7:** Generate and Run Migrations

---

## Notes

- Uses Neon DB via Vercel integration
- DATABASE_URL for pooled connections (app queries)
- DATABASE_URL_UNPOOLED for direct connections (migrations)
- Connection pooling improves performance under load
- Centralized exports make schema changes easier to manage
- Graceful shutdown prevents connection leaks
- Path alias `@/lib/db/schema` keeps imports clean

---

## Usage Examples

### Querying Users

```typescript
import { db } from '@/lib/db'
import { users, type User } from '@/lib/db/schema'
import { eq } from 'drizzle-orm'

// Get all active users
const activeUsers = await db.select().from(users).where(eq(users.accountStatus, 'active'))

// Get user by email
const [user] = await db.select().from(users).where(eq(users.email, 'user@example.com')).limit(1)

// Insert new user
const [newUser] = await db
  .insert(users)
  .values({
    privyDid: 'did:privy:abc123',
    email: 'new@example.com',
    username: 'newuser',
    displayName: 'New User',
    primaryAuthMethod: 'email',
  })
  .returning()
```

### Joining Tables

```typescript
import { db } from '@/lib/db'
import { users, profiles } from '@/lib/db/schema'
import { eq } from 'drizzle-orm'

// Get user with profile
const usersWithProfiles = await db
  .select()
  .from(users)
  .leftJoin(profiles, eq(users.id, profiles.userId))
  .where(eq(users.accountStatus, 'active'))
```

### Server Shutdown Hook (Next.js)

```typescript
// src/lib/db/shutdown.ts
import { closeDatabase } from './index'

if (process.env.NODE_ENV === 'production') {
  process.on('SIGTERM', async () => {
    console.log('SIGTERM received, closing database...')
    await closeDatabase()
    process.exit(0)
  })

  process.on('SIGINT', async () => {
    console.log('SIGINT received, closing database...')
    await closeDatabase()
    process.exit(0)
  })
}
```

---

**Status:** âœ… Ready for Implementation
**Blocking:** E0-T0.7
**Estimated Completion:** 20 minutes
