# E0-T0.8: Verification and Team Sync

**Epic:** 0 - Project Setup & Infrastructure
**Parent:** E0-T0 (Database Setup)
**Story Points:** 1
**Priority:** P0 (Blocker)
**Assignee:** Backend Developer + Team
**Estimated Time:** 30 minutes (plus team sync time)
**Dependencies:** E0-T0.7

---

## Objective

Verify database setup is complete and working, then enable team synchronization so all developers can access the same database and run migrations locally.

---

## Part 1: Final Verification

### Step 1: Run All Test Scripts

Execute all test scripts created in previous tickets:

```bash
# Test schema utilities
bun run scripts/test-schema-utils.ts

# Test users schema
bun run scripts/test-users-schema.ts

# Test profiles schema
bun run scripts/test-profiles-schema.ts

# Test applications and invitations schemas
bun run scripts/test-applications-invitations-schema.ts

# Test database connection
bun run scripts/test-db-connection.ts
```

All tests should pass ‚úÖ

### Step 2: Test CRUD Operations

Create comprehensive CRUD test: `scripts/test-crud-operations.ts`

```typescript
import { db, closeDatabase } from '../src/lib/db'
import { users, profiles, applications, invitations } from '../src/lib/db/schema'
import { eq, sql } from 'drizzle-orm'

async function testCRUDOperations() {
  console.log('üß™ Testing CRUD operations across all tables...\n')

  try {
    // ============================================================
    // CREATE Operations
    // ============================================================

    console.log('üìù CREATE operations:')

    // Create user
    const [newUser] = await db
      .insert(users)
      .values({
        privyDid: 'did:privy:test_crud_user',
        email: 'crud@example.com',
        username: 'crudtest',
        displayName: 'CRUD Test User',
        bio: 'Testing CRUD operations',
        primaryAuthMethod: 'email',
        accountStatus: 'active',
      })
      .returning()

    console.log('  ‚úÖ User created:', newUser.id)

    // Create profile
    const [newProfile] = await db
      .insert(profiles)
      .values({
        userId: newUser.id,
        city: 'Mexico City',
        country: 'Mexico',
        countryCode: 'MX',
        learningTracks: ['ai', 'privacy'],
        profileVisibility: 'public',
        availabilityStatus: 'available',
      })
      .returning()

    console.log('  ‚úÖ Profile created:', newProfile.id)

    // Create application
    const [newApplication] = await db
      .insert(applications)
      .values({
        userId: newUser.id,
        motivationText: 'I want to learn AI and contribute to privacy-focused projects.',
        status: 'approved',
      })
      .returning()

    console.log('  ‚úÖ Application created:', newApplication.id)

    // Create invitation
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
    const [newInvite] = await db
      .insert(invitations)
      .values({
        inviterUserId: newUser.id,
        inviteCode: 'CRUD_TEST_INVITE_2024',
        expiresAt,
      })
      .returning()

    console.log('  ‚úÖ Invitation created:', newInvite.id)

    // ============================================================
    // READ Operations
    // ============================================================

    console.log('\nüìñ READ operations:')

    // Read user by email
    const [foundUser] = await db
      .select()
      .from(users)
      .where(eq(users.email, 'crud@example.com'))
      .limit(1)

    console.log('  ‚úÖ User found by email:', foundUser.username)

    // Read profile by user ID
    const [foundProfile] = await db
      .select()
      .from(profiles)
      .where(eq(profiles.userId, newUser.id))
      .limit(1)

    console.log('  ‚úÖ Profile found:', foundProfile.city)

    // Join user with profile
    const userWithProfile = await db
      .select()
      .from(users)
      .leftJoin(profiles, eq(users.id, profiles.userId))
      .where(eq(users.id, newUser.id))

    console.log('  ‚úÖ User with profile joined:', userWithProfile.length, 'row(s)')

    // ============================================================
    // UPDATE Operations
    // ============================================================

    console.log('\n‚úèÔ∏è  UPDATE operations:')

    // Update user
    const [updatedUser] = await db
      .update(users)
      .set({ displayName: 'Updated CRUD User' })
      .where(eq(users.id, newUser.id))
      .returning()

    console.log('  ‚úÖ User updated:', updatedUser.displayName)

    // Update profile stats
    const [updatedProfile] = await db
      .update(profiles)
      .set({
        completedBounties: 3,
        totalEarningsUsd: 450.75,
        profileViews: 12,
      })
      .where(eq(profiles.id, newProfile.id))
      .returning()

    console.log('  ‚úÖ Profile stats updated:', {
      bounties: updatedProfile.completedBounties,
      earnings: updatedProfile.totalEarningsUsd,
    })

    // Redeem invitation
    const [redeemedInvite] = await db
      .update(invitations)
      .set({
        redeemerUserId: newUser.id,
        redeemedAt: new Date(),
      })
      .where(eq(invitations.id, newInvite.id))
      .returning()

    console.log('  ‚úÖ Invitation redeemed, status:', redeemedInvite.status)

    // ============================================================
    // DELETE Operations
    // ============================================================

    console.log('\nüóëÔ∏è  DELETE operations:')

    // Soft delete user (sets deleted_at)
    await db.update(users).set({ deletedAt: new Date() }).where(eq(users.id, newUser.id))

    console.log('  ‚úÖ User soft deleted')

    // Verify soft delete doesn't appear in active queries
    const activeUsers = await db
      .select()
      .from(users)
      .where(sql`deleted_at IS NULL AND id = ${newUser.id}`)

    console.log(
      '  ‚úÖ Soft deleted user hidden from active queries:',
      activeUsers.length === 0 ? 'YES' : 'NO',
    )

    // ============================================================
    // CASCADE DELETE Test
    // ============================================================

    console.log('\nüîó CASCADE DELETE test:')

    // Hard delete user (should cascade to profile)
    await db.delete(users).where(eq(users.id, newUser.id))

    // Check profile was cascade deleted
    const remainingProfiles = await db
      .select()
      .from(profiles)
      .where(eq(profiles.userId, newUser.id))

    console.log('  ‚úÖ CASCADE DELETE worked:', remainingProfiles.length === 0 ? 'YES' : 'NO')

    // ============================================================
    // Cleanup
    // ============================================================

    await db.delete(applications).where(eq(applications.userId, newUser.id))
    await db.delete(invitations).where(eq(invitations.inviterUserId, newUser.id))
    await db.delete(users).where(eq(users.privyDid, 'did:privy:test_crud_user'))

    console.log('\nüéâ All CRUD operations completed successfully!')
  } catch (error) {
    console.error('‚ùå CRUD operations failed:', error)
    throw error
  } finally {
    await closeDatabase()
  }
}

testCRUDOperations()
```

Run test:

```bash
bun run scripts/test-crud-operations.ts
```

### Step 3: Open Drizzle Studio

Launch Drizzle Studio to visually inspect the database:

```bash
bun run db:studio
```

Open browser to `https://local.drizzle.studio` and verify:

- [ ] All 4 tables visible
- [ ] Sample data can be viewed
- [ ] Relationships shown correctly
- [ ] Enums display properly

---

## Part 2: Team Synchronization

### Step 1: Commit All Schema Files

Ensure all schema files and migrations are committed to git:

```bash
git add drizzle/
git add src/lib/db/
git add scripts/test-*.ts
git add scripts/verify-*.ts
git commit -m "feat: complete database setup with Drizzle ORM

- Add users, profiles, applications, invitations tables
- Configure Drizzle ORM with Neon DB
- Add comprehensive test and verification scripts
- Setup migration workflow

ü§ñ Generated with Claude Code
Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

### Step 2: Team Environment Setup Instructions

Create documentation for team members: `docs/database-setup.md`

```markdown
# Database Setup Guide

## Prerequisites

- Bun installed
- Access to Vercel project
- Git repository cloned

## Step 1: Pull Environment Variables

Pull environment variables from Vercel:

\`\`\`bash
vercel env pull .env.local
\`\`\`

This will download:

- `DATABASE_URL` (pooled connection)
- `DATABASE_URL_UNPOOLED` (direct connection for migrations)

## Step 2: Install Dependencies

\`\`\`bash
bun install
\`\`\`

## Step 3: Run Migrations

Apply all pending migrations:

\`\`\`bash
bun run db:migrate
\`\`\`

## Step 4: Verify Setup

Test database connection:

\`\`\`bash
bun run scripts/test-db-connection.ts
\`\`\`

## Step 5: Open Drizzle Studio

Launch the visual database browser:

\`\`\`bash
bun run db:studio
\`\`\`

Open: https://local.drizzle.studio

## Available Commands

- `bun run db:generate` - Generate new migration from schema changes
- `bun run db:migrate` - Apply pending migrations
- `bun run db:studio` - Open Drizzle Studio (visual DB browser)
- `bun run db:push` - Push schema changes without migration (dev only)
- `bun run db:check` - Check for schema drift

## Schema Files

All database schemas are in `drizzle/schema/`:

- `utils.ts` - Shared utilities (timestamps, soft delete, patterns)
- `users.ts` - User identity and authentication
- `profiles.ts` - Extended user profile data
- `applications.ts` - Onboarding application queue
- `invitations.ts` - Referral invitation system

## Making Schema Changes

1. Edit schema files in `drizzle/schema/`
2. Generate migration: `bun run db:generate`
3. Review generated SQL in `drizzle/migrations/`
4. Apply migration: `bun run db:migrate`
5. Commit migration files to git

## Troubleshooting

### Can't connect to database

- Ensure `.env.local` exists and has DATABASE_URL
- Run `vercel env pull .env.local` to refresh

### Migration already applied error

- This is normal if migrations are already up to date
- Check migration status in database

### Permission denied

- Ensure you have access to the Vercel project
- Ask team lead to add you to project
  \`\`\`

### Step 3: Test Team Sync

1. Ask another team member to:
   - Pull latest code from git
   - Run `vercel env pull .env.local`
   - Run `bun run db:migrate`
   - Run `bun run scripts/test-db-connection.ts`

2. Verify they can:
   - Connect to database
   - See existing tables
   - Run test scripts successfully
   - Open Drizzle Studio

---

## Acceptance Criteria

### Verification

- [ ] All test scripts pass without errors
- [ ] CRUD operations test passes
- [ ] Drizzle Studio opens and shows all tables correctly
- [ ] Sample data can be inserted and queried
- [ ] CASCADE DELETE works as expected
- [ ] Soft delete works as expected

### Team Sync

- [ ] All schema files committed to git
- [ ] All migration files committed to git
- [ ] Database setup guide created
- [ ] At least 2 team members successfully synced and tested
- [ ] Team can run migrations independently
- [ ] Team can access Drizzle Studio

### Documentation

- [ ] `docs/database-setup.md` created with setup instructions
- [ ] README.md updated with database section
- [ ] All test scripts documented and working

---

## Files Created

- `scripts/test-crud-operations.ts`
- `docs/database-setup.md`

---

## Next Steps

After completion:

1. **Epic 1 Kickoff**: Authentication integration with Privy
2. **Schema Monitoring**: Set up slow query alerts in Vercel
3. **Documentation**: Add API documentation for database queries

---

## Success Metrics

‚úÖ **Database Setup Complete** when:

- All tables created with correct schema
- All migrations applied successfully
- All test scripts passing
- Team can independently sync and access database
- Drizzle Studio accessible to all developers
- Documentation reviewed and approved

---

## Notes

- This is the final ticket for Epic 0
- Blocks all of Epic 1 (authentication and onboarding)
- Database is production-ready after this ticket
- Team should be comfortable with migration workflow
- Drizzle Studio is powerful tool for debugging

---

**Status:** ‚úÖ Ready for Implementation
**Blocking:** Epic 1 (All tickets)
**Estimated Completion:** 30 minutes + team sync time
```
